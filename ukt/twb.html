<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Twibbon | PSNU PAGARNUSA UNUSIA</title>
    <link rel="icon" href="https://lh3.googleusercontent.com/d/1v2vvRNo6oFOoBOX-XAxBtkuvLIjfpk5k">
    
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#1B7548', accent: '#0f172a' },
                    animation: { 'float': 'float 3s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; }
        .canvas-container { 
            position: relative; width: 100%; max-width: 450px; aspect-ratio: 1/1; 
            margin: 0 auto; border-radius: 1.5rem; overflow: hidden; touch-action: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); background: #eee; border: 4px solid white;
        }
        canvas { width: 100% !important; height: auto !important; display: block; }
        .step-locked { opacity: 0.3; pointer-events: none; filter: grayscale(1) blur(2px); transition: all 0.5s ease; }
        .step-unlocked { opacity: 1; pointer-events: auto; filter: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col select-none" oncontextmenu="return false;">

    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md py-4 px-5 border-b border-slate-100">
        <div class="max-w-xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="../logopn.png" alt="Logo" class="h-9 animate-float" onerror="this.src='https://via.placeholder.com/50x50?text=PN'">
                <div>
                    <h1 class="text-[11px] font-black text-primary leading-none uppercase">PSNU PAGARNUSA UNUSIA</h1>
                    <p class="text-[8px] text-slate-400 font-bold tracking-widest uppercase">UKT IV & HARLAH 2026</p>
                </div>
            </div>
            <button onclick="window.location.reload()" class="w-9 h-9 rounded-2xl bg-slate-50 text-slate-400 flex items-center justify-center active:bg-slate-200 transition-colors">
                <i class="fas fa-rotate-right text-xs"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 max-w-xl mx-auto w-full px-5 py-8 space-y-12 pb-20">
        <section data-aos="fade-up">
            <div class="flex items-center gap-3 mb-6">
                <span class="w-10 h-10 rounded-2xl bg-primary text-white flex items-center justify-center font-bold">1</span>
                <h2 class="font-bold text-slate-800 text-lg">Atur Foto</h2>
            </div>
            <div class="glass-card rounded-[2.5rem] p-4 space-y-6">
                <div class="canvas-container" id="containerCanvas">
                    <canvas id="twibbonCanvas" width="1080" height="1080"></canvas>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <label class="col-span-4 flex items-center justify-center gap-3 bg-slate-900 text-white py-5 rounded-3xl font-bold text-sm cursor-pointer shadow-xl mb-2 active:scale-95 transition-all">
                        <i class="fas fa-camera text-lg"></i> PILIH FOTO
                        <input type="file" id="inputFoto" accept="image/*" class="hidden">
                    </label>
                    <button onclick="changeZoom(1.1)" class="bg-white border-2 border-slate-50 h-14 rounded-2xl text-slate-600 active:bg-slate-100"><i class="fas fa-plus"></i></button>
                    <button onclick="changeZoom(0.9)" class="bg-white border-2 border-slate-50 h-14 rounded-2xl text-slate-600 active:bg-slate-100"><i class="fas fa-minus"></i></button>
                    <button onclick="rotateImg()" class="bg-white border-2 border-slate-50 h-14 rounded-2xl text-slate-600 active:bg-slate-100"><i class="fas fa-sync-alt"></i></button>
                    <button onclick="resetTransform()" class="bg-red-50 h-14 rounded-2xl text-red-500 active:bg-red-100"><i class="fas fa-trash-can"></i></button>
                </div>
            </div>
        </section>

        <section id="sectionNama" class="step-locked" data-aos="fade-up">
            <div class="flex items-center gap-3 mb-6">
                <span class="w-10 h-10 rounded-2xl bg-primary text-white flex items-center justify-center font-bold">2</span>
                <h2 class="font-bold text-slate-800 text-lg">Masukkan Nama</h2>
            </div>
            <div class="glass-card rounded-[2rem] p-6">
                <input type="text" id="inputNama" oninput="checkFlow()" placeholder="Nama lengkap Anda..." 
                    class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-primary/30 outline-none text-sm font-bold text-slate-700 uppercase">
            </div>
        </section>

        <section id="sectionCopy" class="step-locked" data-aos="fade-up">
            <div class="flex items-center gap-3 mb-6">
                <span class="w-10 h-10 rounded-2xl bg-primary text-white flex items-center justify-center font-bold">3</span>
                <h2 class="font-bold text-slate-800 text-lg">Salin Caption</h2>
            </div>
            <div class="glass-card rounded-[2rem] p-6 space-y-4">
                <div id="previewText" class="p-4 bg-slate-50 rounded-xl text-[10px] text-slate-600 leading-relaxed border border-slate-100 whitespace-pre-line">
                    Lengkapi langkah 1 & 2 untuk melihat caption...
                </div>
                <button onclick="copyCaption()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 active:bg-primary transition-all">
                    <i class="fas fa-copy"></i>
                    <span id="btnCopyText">SALIN TEKS</span>
                </button>
            </div>
        </section>

        <section id="sectionDownload" class="step-locked" data-aos="fade-up">
            <div class="flex items-center gap-3 mb-6">
                <span class="w-10 h-10 rounded-2xl bg-primary text-white flex items-center justify-center font-bold">4</span>
                <h2 class="font-bold text-slate-800 text-lg">Unduh Hasil</h2>
            </div>
            <button onclick="downloadTwibbon()" class="w-full bg-primary text-white py-6 rounded-3xl font-bold shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                <i class="fas fa-download text-xl"></i>
                <span>SIMPAN KE GALERI</span>
            </button>
        </section>
    </main>

    <footer class="py-12 text-center opacity-30">
        <p class="text-[9px] font-bold text-slate-500 tracking-[0.5em] uppercase">PSNU PAGARNUSA UNUSIA</p>
    </footer>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 800, once: true });

        const canvas = document.getElementById('twibbonCanvas');
        const ctx = canvas.getContext('2d');
        
        const frameImg = new Image();
        frameImg.crossOrigin = "anonymous";
        frameImg.src = '../template.png'; // Ganti dengan path gambar template Anda

        let userImg = new Image();
        let imgLoaded = false;
        let frameLoaded = false;
        let scale = 1, posX = 540, posY = 540, rotation = 0;

        frameImg.onload = () => {
            frameLoaded = true;
            draw();
        };

        frameImg.onerror = () => {
            console.error("File template.png tidak ditemukan!");
            ctx.fillStyle = "#1B7548";
            ctx.fillRect(0, 0, 1080, 1080);
            ctx.fillStyle = "white";
            ctx.font = "bold 40px Arial";
            ctx.textAlign = "center";
            ctx.fillText("File template.png tidak ditemukan", 540, 540);
        };

        document.getElementById('inputFoto').onchange = (e) => {
            if (!e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                userImg.onload = () => {
                    imgLoaded = true;
                    document.getElementById('sectionNama').classList.replace('step-locked', 'step-unlocked');
                    resetTransform();
                    checkFlow();
                };
                userImg.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function checkFlow() {
            const nama = document.getElementById('inputNama').value.trim();
            const isValid = imgLoaded && nama.length >= 3;
            
            ['sectionDownload', 'sectionCopy'].forEach(id => {
                const el = document.getElementById(id);
                if (isValid) {
                    el.classList.replace('step-locked', 'step-unlocked');
                } else {
                    el.classList.replace('step-unlocked', 'step-locked');
                }
            });

            if (isValid) updateCaptionPreview(nama);
        }

        function updateCaptionPreview(nama) {
            const caption = `Lahir untuk Mengabdi, Berdiri untuk Membela. ðŸ¦…ðŸ’š\n\nSaya ${nama.toUpperCase()}, siap menyukseskan dan mengikuti seluruh rangkaian HARLAH & UKT PSNU PAGARNUSA IV. Dengan semangat 'Laa Ghaliba Illa Billah', saya siap  merapatkan barisan di bawah naungan Nahdlatul Ulama.\nNKRI Harga Mati, Pagar Nusa Sampai Mati!\n\n@pagarnusaunusia @unuindonesia @ukm.pencaksilatunusia @pagarnusaindonesia @pagarnusa.or.id\n#PagarNusa #PagarNusaIndonesia #UKTPagarNusa2026 #NahdlatulUlama #SantriPagarNusa #LaaGhalibaIllaBillah`;
            document.getElementById('previewText').innerText = caption;
        }

        function draw() {
            ctx.clearRect(0, 0, 1080, 1080);
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, 1080, 1080);
            
            if (imgLoaded) {
                ctx.save();
                ctx.translate(posX, posY);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.drawImage(userImg, -(userImg.width * scale) / 2, -(userImg.height * scale) / 2, userImg.width * scale, userImg.height * scale);
                ctx.restore();
            }
            
            if (frameLoaded) {
                ctx.drawImage(frameImg, 0, 0, 1080, 1080);
            }
        }

        function changeZoom(factor) { if (imgLoaded) { scale *= factor; draw(); } }
        function rotateImg() { if (imgLoaded) { rotation += 90; draw(); } }
        function resetTransform() {
            if (!imgLoaded) return;
            scale = Math.max(1080 / userImg.width, 1080 / userImg.height);
            posX = 540; posY = 540; rotation = 0;
            draw();
        }

        const mc = new Hammer.Manager(canvas);
        mc.add(new Hammer.Pinch());
        mc.add(new Hammer.Pan());

        let lastScale = 1;
        mc.on("pinchstart", () => { lastScale = scale; });
        mc.on("pinchmove", (e) => { scale = lastScale * e.scale; draw(); });

        let lastPosX, lastPosY;
        mc.on("panstart", () => { lastPosX = posX; lastPosY = posY; });
        mc.on("panmove", (e) => {
            const rect = canvas.getBoundingClientRect();
            const ratio = 1080 / rect.width;
            posX = lastPosX + (e.deltaX * ratio);
            posY = lastPosY + (e.deltaY * ratio);
            draw();
        });

        function downloadTwibbon() {
            const nama = document.getElementById('inputNama').value.trim().toUpperCase() || 'PAGAR_NUSA';
            const link = document.createElement('a');
            link.download = `Twibbon_PN_${nama}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        async function copyCaption() {
            const caption = document.getElementById('previewText').innerText;
            const btnText = document.getElementById('btnCopyText');
            try {
                await navigator.clipboard.writeText(caption);
                btnText.innerText = "BERHASIL DISALIN!";
                setTimeout(() => { btnText.innerText = "SALIN TEKS"; }, 2000);
            } catch (err) {
                alert("Gagal menyalin. Silakan tekan lama teks di atas untuk menyalin manual.");
            }
        }
    </script>
</body>
</html>
