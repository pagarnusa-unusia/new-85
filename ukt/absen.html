<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Registrasi PN</title>
    
    <link rel="icon" type="image/png" href="../logopn.png">
    <link rel="apple-touch-icon" href="../logopn.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        :root { --pn-green: #166534; }
        body { background-color: #f9fafb; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }

        /* Scanner Styling */
        #reader { 
            border: none !important; 
            border-radius: 2.5rem; 
            overflow: hidden;
            aspect-ratio: 1 / 1; 
            background: #000;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Navigasi Styling */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nav-item.active { color: var(--pn-green); background: #f0fdf4; border-top: 3px solid var(--pn-green); }

        /* Registration Page System */
        .reg-sub-page { display: none; }
        .reg-sub-page.active { display: block; }

        /* Custom Checkbox */
        input[type="checkbox"] { width: 24px; height: 24px; accent-color: var(--pn-green); }

        /* Sembunyikan elemen sampah library */
        #reader__dashboard_section_csr span, #reader__status_span, #reader__dashboard_section_fsr { display: none !important; }
    </style>
</head>
<body class="flex flex-col min-h-screen pb-28">

    <header class="bg-[#166534] text-white p-5 text-center shadow-lg sticky top-0 z-50">
        <h1 class="text-[10px] font-black tracking-[0.3em] uppercase">Sistem Absensi Terpadu</h1>
        <p class="text-[9px] opacity-70 mt-1 uppercase font-bold">Pagar Nusa - UKT IV 2026</p>
    </header>

    <main id="absensi-page" class="tab-content active p-6">
        <div class="w-full max-w-sm mx-auto bg-white rounded-[3rem] p-3 mb-6 shadow-sm relative border border-gray-100">
            <button onclick="switchCamera()" class="absolute top-6 right-6 z-30 bg-white/90 backdrop-blur-md p-4 rounded-full shadow-xl text-[#166534] active:scale-90 transition-all">
                <i class="fas fa-camera-rotate text-xl"></i>
            </button>
            <div id="reader"></div>
            <div id="status-info" class="mt-4 text-center py-4 px-6 bg-gray-50 rounded-2xl text-[10px] font-black text-gray-400 uppercase tracking-widest transition-all">
                Mencari Kode QR...
            </div>
        </div>

        <div id="validation-alert" class="hidden bg-rose-50 p-4 rounded-2xl border border-rose-100 flex items-center gap-3 animate-pulse">
            <i class="fas fa-exclamation-triangle text-rose-500"></i>
            <p class="text-[10px] text-rose-700 font-black uppercase">Gagal: Peserta belum lengkap registrasi alat!</p>
        </div>
    </main>

    <main id="registrasi-page" class="tab-content p-6">
        <div id="reg-sub-1" class="reg-sub-page active">
            <div class="flex flex-col gap-4">
                <h2 class="font-black text-gray-800 text-lg uppercase tracking-tight">Daftar Peserta</h2>
                <div class="relative">
                    <input type="text" id="searchName" onkeyup="renderNameList()" placeholder="Cari nama..." 
                    class="w-full bg-white border border-gray-100 shadow-sm rounded-2xl py-4 pl-12 pr-4 text-sm focus:ring-2 focus:ring-green-500 outline-none">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-gray-300"></i>
                </div>
                <div id="name-list" class="space-y-3"></div>
            </div>
        </div>

        <div id="reg-sub-2" class="reg-sub-page">
            <div class="bg-white rounded-[2.5rem] p-6 shadow-xl border border-gray-50">
                <button onclick="goBackToNames()" class="mb-6 text-gray-400 text-[10px] font-black uppercase flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
                <h3 id="current-peserta-name" class="text-xl font-black text-[#166534] uppercase leading-tight">Nama Peserta</h3>
                <p class="text-[10px] text-gray-400 font-bold mb-6 italic uppercase">Pemeriksaan Atribut</p>
                <div id="checklist-container" class="space-y-3 mb-8"></div>
                <button onclick="finishRegistration()" class="w-full bg-[#166534] text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all shadow-lg">
                    Selesai & Kunci
                </button>
            </div>
        </div>
    </main>

    <main id="riwayat-page" class="tab-content p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="font-black text-gray-800 text-lg uppercase tracking-tight">Sesi Terkini</h2>
            <button onclick="downloadCSV()" class="p-2 bg-emerald-50 text-emerald-700 rounded-xl text-[10px] font-black">
                <i class="fas fa-file-csv mr-1"></i> EXPORT
            </button>
        </div>
        <div id="history-list" class="space-y-3"></div>
    </main>

    <main id="cetak-page" class="tab-content p-6">
        <div class="flex flex-col gap-6">
            <h2 class="font-black text-gray-800 text-lg uppercase tracking-tight">Panel Administrasi</h2>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="openCetakFeature('template')" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col items-center text-center group active:scale-95 transition-all">
                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-xl mb-3 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        <i class="fas fa-palette"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase text-gray-700 leading-tight">Edit<br>Template</span>
                </button>

                <button onclick="openCetakFeature('view')" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col items-center text-center group active:scale-95 transition-all">
                    <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-2xl flex items-center justify-center text-xl mb-3 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                        <i class="fas fa-database"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase text-gray-700 leading-tight">View<br>Data</span>
                </button>

                <button onclick="openCetakFeature('laporan')" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col items-center text-center group active:scale-95 transition-all">
                    <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-xl mb-3 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase text-gray-700 leading-tight">Cetak<br>Laporan</span>
                </button>

                <button onclick="openCetakFeature('idcard')" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col items-center text-center group active:scale-95 transition-all">
                    <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-2xl flex items-center justify-center text-xl mb-3 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                        <i class="fas fa-address-card"></i>
                    </div>
                    <span class="text-[10px] font-black uppercase text-gray-700 leading-tight">Cetak<br>Kartu</span>
                </button>
            </div>

            <div class="bg-gray-800 p-6 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                <i class="fas fa-print absolute -right-4 -bottom-4 text-7xl opacity-10"></i>
                <h3 class="text-sm font-black uppercase mb-1">Status Sinkronisasi</h3>
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <p class="text-[9px] font-bold text-green-400 uppercase">Cloud Database Active</p>
                </div>
                <p class="text-[10px] text-gray-400 leading-relaxed font-medium">Data tersinkronisasi otomatis dengan Google Spreadsheet Anda.</p>
            </div>
        </div>
    </main>

    <div id="modalWarning" class="fixed inset-0 bg-black/80 z-[60] hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] overflow-hidden shadow-2xl border-4 border-orange-400">
            <div class="bg-orange-50 py-8 text-center">
                <span class="text-5xl">⚠️</span>
                <h2 class="text-lg font-black text-orange-700 mt-2 uppercase">SUDAH ABSEN</h2>
            </div>
            <div class="p-6 text-center">
                <h3 id="warn-name" class="text-md font-black text-gray-800 uppercase italic leading-tight">NAMA</h3>
            </div>
            <div class="p-4">
                <button onclick="closeWarning()" class="w-full bg-orange-500 text-white py-4 rounded-xl font-black text-xs uppercase shadow-lg shadow-orange-100">Lanjutkan Scan</button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-100 flex justify-around items-center h-20 z-50">
        <button onclick="switchTab('absensi')" id="nav-absensi" class="nav-item active flex flex-col items-center justify-center w-full h-full text-gray-400 transition-all">
            <i class="fas fa-qrcode text-lg"></i>
            <span class="text-[8px] font-black mt-1 uppercase">Absensi</span>
        </button>
        <button onclick="switchTab('registrasi')" id="nav-registrasi" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 transition-all border-x border-gray-50">
            <i class="fas fa-user-check text-lg"></i>
            <span class="text-[8px] font-black mt-1 uppercase">Registrasi</span>
        </button>
        <button onclick="switchTab('riwayat')" id="nav-riwayat" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 transition-all border-r border-gray-50">
            <i class="fas fa-list-ul text-lg"></i>
            <span class="text-[8px] font-black mt-1 uppercase">Riwayat</span>
        </button>
        <button onclick="switchTab('cetak')" id="nav-cetak" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 transition-all">
            <i class="fas fa-print text-lg"></i>
            <span class="text-[8px] font-black mt-1 uppercase">Cetak</span>
        </button>
    </nav>

<script>
    // --- KONFIGURASI DATABASE ---
    const SPREADSHEET_UI_URL = "https://docs.google.com/spreadsheets/d/1x_SqgAE1nfzqxvfe-Tv3d9jHCdykOWofyvrvpwBOeIA/edit"; 
    const EXPORT_BASE = "https://docs.google.com/spreadsheets/d/1x_SqgAE1nfzqxvfe-Tv3d9jHCdykOWofyvrvpwBOeIA/export";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypkLAOISZHAnGagYziGq_RmWKAdUZMe3qXzu4ebAUbzN4wptTHwJ2ei8jNQVSr3a89ig/exec";
    const TEMPLATE_URL = "https://docs.google.com/document/d/1wahBVQkK8_GXlumYKfomgFFEAlXeUgh473KnEAtCf_U/edit";

    const pesertaList = ["Agung Prayuda", "Ardan Mizanul Khoiri", "Citra Hayatunnufus", "Dede Ahmad Fauzan", "Dinda Ayuni", "Dwi Nur Aini", "Fadli Al Masani", "Hoirul Sambudi", "Khairun Anwar", "Mochammad Wafi Nur Jihan", "Muhammad Maulana Naufal Widodo", "Nur Zalfa Sahiyah", "Nurul Hidayah Harahap", "Ramlan", "Rendi Imam Saputra", "Syahrul Mubarok", "Wilda Nazwatun Nisa"];

    let isProcessing = false;
    let html5QrCode = new Html5Qrcode("reader");
    let historyData = JSON.parse(localStorage.getItem('pn_history_v4') || '[]');
    let regData = {}; 
    let currentFacingMode = "environment";

    // --- CLOUD SYNC LOGIC ---
    async function syncDataFromCloud() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            data.slice(1).forEach(row => {
                regData[row[0]] = { c1: row[1], c2: row[2], c3: row[3], c4: row[4], c5: row[5] };
            });
            if(document.getElementById('registrasi-page').classList.contains('active')) renderNameList();
        } catch (e) { console.error("Sync Gagal:", e); }
    }

    // --- CAMERA LOGIC ---
    function startCamera() {
        const config = { fps: 25, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        html5QrCode.start({ facingMode: currentFacingMode }, config, onScanSuccess)
        .catch(() => html5QrCode.start({ facingMode: "any" }, config, onScanSuccess));
    }

    async function switchCamera() {
        if (isProcessing) return;
        currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
        try { await html5QrCode.stop(); startCamera(); } catch (err) { startCamera(); }
    }

    function onScanSuccess(decodedText) {
        if (isProcessing) return;
        isProcessing = true;

        const [id, nama] = decodedText.split('|');
        const checks = regData[nama] || {};
        const doneCount = Object.values(checks).filter(Boolean).length;

        if (doneCount < 5) {
            showValidationAlert();
            setTimeout(() => { isProcessing = false; hideValidationAlert(); }, 3000);
            return;
        }

        if (historyData.some(h => h.id === id)) {
            document.getElementById('warn-name').innerText = nama;
            showWarning();
            return;
        }

        if (navigator.vibrate) navigator.vibrate(100);
        updateStatus("✅ BERHASIL DICATAT", "bg-emerald-600 text-white");

        const entry = {
            id, nama,
            waktu: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}),
            tanggal: new Date().toLocaleDateString('id-ID')
        };

        historyData.unshift(entry);
        localStorage.setItem('pn_history_v4', JSON.stringify(historyData));
        
        fetch(SCRIPT_URL, { 
            method: "POST", 
            mode: "no-cors", 
            body: JSON.stringify({ action: "absensi", data: decodedText }) 
        }).finally(() => setTimeout(() => resetScanner(), 1500));
    }

    // --- REGISTRATION LOGIC ---
    function renderNameList() {
        const q = document.getElementById('searchName').value.toLowerCase();
        const container = document.getElementById('name-list');
        container.innerHTML = pesertaList.filter(n => n.toLowerCase().includes(q)).map(nama => {
            const done = Object.values(regData[nama] || {}).filter(Boolean).length;
            return `
                <div onclick="openChecklist('${nama}')" class="bg-white p-5 rounded-2xl flex items-center justify-between border border-gray-100 shadow-sm active:scale-95 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl ${done === 5 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-400'} flex items-center justify-center font-black text-[10px]">
                            ${done === 5 ? '<i class="fas fa-check"></i>' : done + '/5'}
                        </div>
                        <span class="text-xs font-black text-gray-700 uppercase">${nama}</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-200 text-xs"></i>
                </div>`;
        }).join('');
    }

    function openChecklist(nama) {
        document.getElementById('current-peserta-name').innerText = nama;
        document.getElementById('reg-sub-1').classList.remove('active');
        document.getElementById('reg-sub-2').classList.add('active');
        
        const checks = regData[nama] || { c1:false, c2:false, c3:false, c4:false, c5:false };
        const labels = ['Indomie Goreng | Telur | Roti Aoka | Apel', 'Kopi Liong | Madu | Susu Jahe', 'Seragam Pagar Nusa | baju ganti | Peci/Kerudung', 'Sertifikat UKT | alat tulis lengkap', 'Perlengkapan ibadah | peralatan mandi | Handphone'];
        
        document.getElementById('checklist-container').innerHTML = labels.map((label, i) => `
            <label class="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl border border-transparent has-[:checked]:border-green-200 has-[:checked]:bg-green-50 transition-all">
                <input type="checkbox" onchange="toggleReg('${nama}', 'c${i+1}')" ${checks['c'+(i+1)] ? 'checked' : ''}>
                <span class="text-[11px] font-black text-gray-600 ">${label}</span>
            </label>`).join('');
    }

    function toggleReg(nama, key) {
        if (!regData[nama]) regData[nama] = {c1:false, c2:false, c3:false, c4:false, c5:false};
        regData[nama][key] = !regData[nama][key];
        
        fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({
                action: "registrasi",
                nama: nama,
                item: key,
                status: regData[nama][key]
            })
        });
    }

    function finishRegistration() {
        document.getElementById('reg-sub-2').classList.remove('active');
        document.getElementById('reg-sub-1').classList.add('active');
        renderNameList();
    }

    function goBackToNames() {
        document.getElementById('reg-sub-2').classList.remove('active');
        document.getElementById('reg-sub-1').classList.add('active');
    }

    // --- NAVIGATION & UI ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('nav-' + tab).classList.add('active');
        document.getElementById(tab + '-page').classList.add('active');

        if (tab === 'absensi') startCamera();
        else {
            html5QrCode.stop().catch(()=>{});
            if (tab === 'registrasi') { syncDataFromCloud(); renderNameList(); }
            if (tab === 'riwayat') renderHistory();
        }
    }

    function renderHistory() {
        const container = document.getElementById('history-list');
        if (historyData.length === 0) {
            container.innerHTML = '<div class="text-center py-20 text-gray-300 text-[10px] font-black uppercase">Belum ada riwayat</div>';
            return;
        }
        container.innerHTML = historyData.map(h => `
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-1.5 h-8 bg-green-600 rounded-full"></div>
                    <div>
                        <h4 class="text-[11px] font-black text-gray-800 uppercase">${h.nama}</h4>
                        <p class="text-[9px] text-gray-400 font-bold">${h.waktu} • SUCCESS</p>
                    </div>
                </div>
            </div>`).join('');
    }

    function openCetakFeature(type) {
        const gid = "0"; 
        switch(type) {
            case 'template': window.open(TEMPLATE_URL, '_blank'); break;
            case 'view': window.open(SPREADSHEET_UI_URL, '_blank'); break;
            case 'laporan':
                if(confirm("Download Laporan A4 Portrait?")) {
                    const params = ['format=pdf','size=a4','portrait=true','fitw=true','gridlines=false','gid=' + gid].join('&');
                    window.open(EXPORT_BASE + "?" + params, '_blank');
                }
                break;
            case 'idcard':
                if(confirm("Cetak Kartu?")) window.open(EXPORT_BASE + "?format=pdf&size=a4&portrait=false&gid=" + gid, '_blank');
                break;
        }
    }

    function showValidationAlert() { document.getElementById('validation-alert').classList.remove('hidden'); }
    function hideValidationAlert() { document.getElementById('validation-alert').classList.add('hidden'); }
    function showWarning() { document.getElementById('modalWarning').style.display = 'flex'; }
    function closeWarning() { document.getElementById('modalWarning').style.display = 'none'; resetScanner(); }
    function updateStatus(t, c) {
        const el = document.getElementById('status-info');
        el.innerText = t;
        el.className = `mt-4 text-center py-4 px-6 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all ${c}`;
    }
    function resetScanner() { isProcessing = false; updateStatus("Mencari Kode QR...", "bg-gray-50 text-gray-400"); }
    
    function downloadCSV() {
        let csv = "ID,Nama,Waktu,Tanggal\n";
        historyData.forEach(h => csv += `${h.id},${h.nama},${h.waktu},${h.tanggal}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Data_PN_UKT4.csv`;
        a.click();
    }

    window.onload = () => { startCamera(); syncDataFromCloud(); };
</script>
</body>
</html>
